<!DOCTYPE html>
<html>
<head>
    <title>Почта с тегами</title>
    <meta charset='utf-8'>
    <style>
        .Page {
            font-family: Arial;
            font-size: 12px;
            margin: 0;
            padding: 0;
            color: #2f2d33;
        }
        .Logo {
            font-size: 24px;
            padding: 12px;
            margin: 0;
        }
        .Main {
            display: flex;
        }
        .Tags {
            width: 25%;
            background-color: #fffae5;
            padding: 6px;
        }
        .Tags_dropzone {
            background-color: #ffedba;
        }
        .Tags_dragovered {
            background-color: #ffd98e;
        }
        .Tags_dragovered * {
            pointer-events: none;
        }
        .Tag {
            background-color: #ffc062;
            color: #592400;
            margin: 6px;
            padding: 6px;
            display: inline-block;
        }
        .Tag_dragged {
            background-color: #ff9100;
        }
        .Tag_removed {
            display: none;
        }
        .Letters {
            width: 100%;
            background-color: #91cfff;
        }
        .Letters_dropzone {
            background-color: #4da0ff;
        }
        .Letter {
            display: flex;
            color: #00244d;
        }
        .Letter_dragovered {
            background-color: #006fed;
        }
        .Letter_dragovered * {
            pointer-events: none;
        }
        .Letter__Title {
            margin: 12px;
        }
    </style>
</head>

<body class="Page">
<script>
    let data = window.data || {
        tags: {
            '1': 'важное',
            '2': 'личное',
            '3': 'рабочее',
            '4': 'Проект X',
            '5': 'Проект Y'
        },
        letters: [
            {
                id: '1',
                title: 'Приглашение на день рождения',
                tags: ['1', '2']
            },
            {
                id: '2',
                title: 'Ответ на ваш комментарий',
                tags: ['2']
            },
            {
                id: '3',
                title: 'Резюме последней встречи про X',
                tags: ['3', '4']
            },
            {
                id: '4',
                title: 'Расчётный лист',
                tags: ['1', '3']
            },
            {
                id: '5',
                title: 'Нужна помощь с Y',
                tags: ['3', '5']
            },
            {
                id: '6',
                title: 'Регулярная рассылка для клиентов',
                tags: []
            }
        ]
    }

    function mapAndJoin(a, f, s = '') { return a.map(f).join(s) }
    function buildHtml(data) {
        return `
      <div class="Main">
        <div class="Tags">
          ${mapAndJoin(
            Object.entries(data.tags),
            ([id, title]) => buildTagHtml(id, title))}
        </div>
        <div class="Letters">
          ${mapAndJoin(
            data.letters,
            ({ id, title, tags }) => `
              <div class="Letter" data-letter-id="${id}">
                <div class="Letter__Title">${title}</div>
                ${mapAndJoin(tags, (l) => buildTagHtml(l, data.tags[l]))}
              </div>
            `)}
        </div>
      </div>
    `
    }
    function buildTagHtml(id, title) {
        return `<div class="Tag" data-tag-id="${id}">${title}</div>`
    }
    document.body.innerHTML = buildHtml(data);
    window.onSolutionReady && window.onSolutionReady();



    // TAG EVENTS
    function onTagDrag (e) {

        e.preventDefault();
        e.stopPropagation();

        const element = e.target.closest('.Tag');

        if (!dragElement) {
            dragElement = element;
        }


        element.classList.add('Tag_dragged');

        if (element.parentElement?.classList?.contains('Letter')) {

            //element.classList.add('Tag_removed')

            tagZone.classList.add('Tags_dropzone');
        }
        letZone.classList.add('Letters_dropzone');

    }


    function onTagDragEnd (e) {

        e.preventDefault();

        e.target.closest('.Tag')?.classList?.remove('Tag_dragged', /*'Tag_removed'*/);
        Array.from(document.querySelectorAll('.Letter')).forEach(item => item.classList.remove('Letter_dragovered'));
        tagZone.classList.remove('Tags_dragovered', 'Tags_dropzone');
        letZone.classList.remove('Letters_dropzone');

        dragElement = undefined;
    }


    function onTagZoneDrop (e) {

        e.preventDefault();
        if (dragElement?.parentElement?.classList?.contains('Letter')) {
            dragElement.remove();
        }


    }


    function onTagDragenter (e) {
        e.preventDefault();
        if (dragElement?.parentElement?.classList?.contains('Letter')) {
            tagZone.classList.add('Tags_dragovered');
        }
    }

    function onTagDragleave (e) {
        e.preventDefault();
        tagZone.classList.remove('Tags_dragovered', 'Tags_dropzone');
    }


    // LETTER EVENTS
    function onLetterDragover (e) {

        e.preventDefault();

    }

    function onLetterDrop (e) {

        e.preventDefault();

        if (!(Array.from(e.target.closest('.Letter').querySelectorAll(".Tag")).map(item => item.innerHTML)).includes(dragElement.innerHTML)) {


            const newTag = dragElement.cloneNode( true );
            newTag.draggable = true;
            newTag.addEventListener('drag', onTagDrag);
            newTag.addEventListener('dragend', onTagDragEnd);

            e.target.closest('.Letter').appendChild(newTag);

            if (dragElement?.parentElement?.classList?.contains('Letter')) {
                dragElement.classList.add('Tag_removed');
                dragElement.remove();
            }

            //const newTag = dragElement?.parentElement?.classList?.contains('Tags') ? dragElement.cloneNode( true ) : dragElement;

            Array.from(document.querySelectorAll('.Tag')).forEach(item => item.classList.remove('Tag_dragged', /*'Tag_removed'*/));
            Array.from(document.querySelectorAll('.Letter')).forEach(item => item.classList.remove('Letter_dragovered'));
            tagZone.classList.remove('Tags_dragovered', 'Tags_dropzone');
            letZone.classList.remove('Letters_dropzone');

        }

    }

    function onLetterDragenter (e) {
        e.preventDefault();
        const list = e.target.closest('.Letter');
        if (!Array.from(list.querySelectorAll('.Tag')).map(item => item.innerHTML).includes(dragElement?.innerHTML)) {
            list.classList.add('Letter_dragovered');
        }
    }

    function onLetterDragleave (e) {
        e.preventDefault();
        e.target.closest('.Letter')?.classList.remove('Letter_dragovered');
    }


    // TAG ZONE EVENTS
    function onTagZoneDragover (e) {
        e.preventDefault();
    }

    const tagZone = document.querySelector('.Tags');
    const letZone = document.querySelector('.Letters');

    const tagList = document.querySelectorAll('.Tag');
    const letterList = document.querySelectorAll('.Letter');


    let dragElement = undefined;


    // TAG
    for (const tag of tagList) {
        tag.draggable = true;
        tag.addEventListener('drag', onTagDrag);
        tag.addEventListener('dragend', onTagDragEnd);
    }

    // LETTER
    for (const letter of letterList) {
        letter.addEventListener('dragover', onLetterDragover);
        letter.addEventListener('drop', onLetterDrop);
        letter.addEventListener('dragenter', onLetterDragenter);
        letter.addEventListener('dragleave', onLetterDragleave);
    }



    // TAG ZONE
    tagZone.addEventListener('dragover', onTagZoneDragover);
    tagZone.addEventListener('drop', onTagZoneDrop);
    tagZone.addEventListener('dragenter', onTagDragenter);
    tagZone.addEventListener('dragleave', onTagDragleave);




</script>
</body>
</html>
